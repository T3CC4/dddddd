<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-users"></i> Benutzerverwaltung</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-squad" onclick="showCreateWebUserModal()">
                <i class="fas fa-plus"></i> Web-Benutzer erstellen
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshUserData()">
                <i class="fas fa-sync-alt"></i> Aktualisieren
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportUsers()">
                <i class="fas fa-download"></i> Exportieren
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">
                    <i class="fab fa-discord"></i>
                    <%= discordUsers.length %>
                </h5>
                <p class="card-text">Discord Benutzer</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">
                    <i class="fas fa-check-circle"></i>
                    <%= discordUsers.filter(u => u.verified).length %>
                </h5>
                <p class="card-text">Verifiziert</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    <i class="fas fa-clock"></i>
                    <%= discordUsers.filter(u => !u.verified).length %>
                </h5>
                <p class="card-text">Ausstehend</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    <i class="fas fa-globe"></i>
                    <%= webUsers.length %>
                </h5>
                <p class="card-text">Web Benutzer</p>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="userTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="discord-users-tab" data-bs-toggle="tab" data-bs-target="#discord-users" type="button" role="tab">
            <i class="fab fa-discord"></i> Discord Benutzer (<%= discordUsers.length %>)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="web-users-tab" data-bs-toggle="tab" data-bs-target="#web-users" type="button" role="tab">
            <i class="fas fa-globe"></i> Web Benutzer (<%= webUsers.length %>)
        </button>
    </li>
</ul>

<div class="tab-content" id="userTabsContent">
    <div class="tab-pane fade show active" id="discord-users" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Discord Server Mitglieder</h5>
                <div class="d-flex gap-2">
                    <div class="input-group" style="width: 250px;">
                        <input type="text" class="form-control form-control-sm" id="discordSearch" placeholder="Benutzer suchen...">
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="filterDiscordUsers()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <select class="form-select form-select-sm" id="discordFilter" onchange="filterDiscordUsers()" style="width: 150px;">
                        <option value="">Alle Status</option>
                        <option value="verified">Verifiziert</option>
                        <option value="pending">Ausstehend</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <% if (discordUsers.length === 0) { %>
                <div class="text-center py-4">
                    <i class="fab fa-discord fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Keine Discord-Benutzer gefunden.</p>
                </div>
                <% } else { %>
                
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="discordUsersTable">
                        <thead>
                            <tr>
                                <th width="20%">Benutzer</th>
                                <th width="15%">Status</th>
                                <th width="15%">Beigetreten</th>
                                <th width="20%">Aktivität</th>
                                <th width="30%">Moderation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% discordUsers.forEach(function(discordUser) { %>
                            <tr class="discord-user-row" 
                                data-search="<%= discordUser.username.toLowerCase() %> <%= discordUser.id %>" 
                                data-status="<%= discordUser.verified ? 'verified' : 'pending' %>">
                                <td>
                                    <div class="user-profile">
                                        <img src="https://cdn.discordapp.com/embed/avatars/<%= parseInt(discordUser.id) % 5 %>.png" 
                                             alt="<%= discordUser.username %>" class="user-avatar me-2">
                                        <div class="user-info">
                                            <div class="username">
                                                <strong><%= discordUser.username %></strong>
                                                <% if (discordUser.verified) { %>
                                                    <i class="fas fa-check-circle text-success ms-1" title="Verifiziert"></i>
                                                <% } %>
                                            </div>
                                            <div class="user-id">
                                                <code><%= discordUser.id %></code>
                                                <button class="btn btn-link btn-sm p-0 ms-1" onclick="copyToClipboard('<%= discordUser.id %>')" title="ID kopieren">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <% if (discordUser.verified) { %>
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Verifiziert
                                        </span>
                                    <% } else { %>
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock"></i> Ausstehend
                                        </span>
                                        <% if (discordUser.verification_code) { %>
                                        <br><small class="text-muted">Code: <code><%= discordUser.verification_code %></code></small>
                                        <% } %>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="join-date">
                                        <%= new Date(discordUser.joined_at).toLocaleDateString('de-DE') %>
                                    </div>
                                    <small class="text-muted">
                                        <%= Math.floor((Date.now() - new Date(discordUser.joined_at)) / (1000 * 60 * 60 * 24)) %> Tage
                                    </small>
                                </td>
                                <td>
                                    <div class="activity-stats" id="activity-<%= discordUser.id %>">
                                        <div class="loading-placeholder">
                                            <i class="fas fa-spinner fa-spin"></i> Lädt...
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="moderation-actions">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <% if (!discordUser.verified) { %>
                                            <button class="btn btn-outline-success" onclick="verifyUser('<%= discordUser.id %>')" title="Manuell verifizieren">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <% } %>
                                            
                                            <button class="btn btn-outline-info" onclick="showUserDetails('<%= discordUser.id %>')" title="Details anzeigen">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" title="Moderation">
                                                    <i class="fas fa-gavel"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-dark">
                                                    <li><a class="dropdown-item" href="#" onclick="moderateUser('<%= discordUser.id %>', 'kick')">
                                                        <i class="fas fa-door-open"></i> Kicken
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="moderateUser('<%= discordUser.id %>', 'ban')">
                                                        <i class="fas fa-ban"></i> Bannen
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="moderateUser('<%= discordUser.id %>', 'timeout')">
                                                        <i class="fas fa-clock"></i> Timeout
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item" href="#" onclick="resetVerification('<%= discordUser.id %>')">
                                                        <i class="fas fa-redo"></i> Verifikation zurücksetzen
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="deletePersonalChannel('<%= discordUser.id %>')">
                                                        <i class="fas fa-trash"></i> Persönlichen Channel löschen
                                                    </a></li>
                                                </ul>
                                            </div>
                                            
                                            <button class="btn btn-outline-secondary" onclick="openDiscordProfile('<%= discordUser.id %>')" title="Discord Profil">
                                                <i class="fab fa-discord"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                
                <% } %>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="web-users" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Web Interface Benutzer</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-squad btn-sm" onclick="showCreateWebUserModal()">
                        <i class="fas fa-plus"></i> Neuen Benutzer erstellen
                    </button>
                    <select class="form-select form-select-sm" id="webUserFilter" onchange="filterWebUsers()" style="width: 120px;">
                        <option value="">Alle Rollen</option>
                        <option value="admin">Admins</option>
                        <option value="mod">Moderatoren</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <% if (webUsers.length === 0) { %>
                <div class="text-center py-4">
                    <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Keine Web-Benutzer gefunden.</p>
                    <button class="btn btn-squad" onclick="showCreateWebUserModal()">
                        <i class="fas fa-plus"></i> Ersten Benutzer erstellen
                    </button>
                </div>
                <% } else { %>
                
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="webUsersTable">
                        <thead>
                            <tr>
                                <th width="25%">Benutzer</th>
                                <th width="15%">Rolle</th>
                                <th width="20%">Unique Password</th>
                                <th width="20%">Login-Info</th>
                                <th width="20%">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% webUsers.forEach(function(webUser) { %>
                            <tr class="web-user-row" data-role="<%= webUser.role %>">
                                <td>
                                    <div class="user-profile">
                                        <div class="user-avatar-web me-2">
                                            <i class="fas fa-<%= webUser.role === 'admin' ? 'crown' : 'shield-alt' %>"></i>
                                        </div>
                                        <div class="user-info">
                                            <div class="username">
                                                <strong><%= webUser.username %></strong>
                                                <% if (webUser.username === user.username) { %>
                                                    <span class="badge bg-info ms-1">Du</span>
                                                <% } %>
                                            </div>
                                            <div class="user-meta">
                                                ID: <%= webUser.id %>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-<%= webUser.role === 'admin' ? 'danger' : 'warning' %> role-badge">
                                        <i class="fas fa-<%= webUser.role === 'admin' ? 'crown' : 'shield-alt' %>"></i>
                                        <%= webUser.role.toUpperCase() %>
                                    </span>
                                </td>
                                <td>
                                    <div class="unique-password-container">
                                        <code class="unique-password" onclick="copyToClipboard('<%= webUser.unique_password %>')" title="Klicken zum Kopieren">
                                            <%= webUser.unique_password %>
                                        </code>
                                        <button class="btn btn-link btn-sm p-0 ms-1" onclick="regenerateUniquePassword('<%= webUser.id %>')" title="Regenerieren">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="login-info">
                                        <div class="created-date">
                                            <small class="text-muted">Erstellt:</small><br>
                                            <%= new Date(webUser.created_at).toLocaleDateString('de-DE') %>
                                        </div>
                                        <div class="last-login mt-1">
                                            <small class="text-muted">Letzter Login:</small><br>
                                            <% if (webUser.last_login) { %>
                                                <%= new Date(webUser.last_login).toLocaleDateString('de-DE') %>
                                                <br><small class="text-info">
                                                    <%= Math.floor((Date.now() - new Date(webUser.last_login)) / (1000 * 60 * 60 * 24)) %> Tage her
                                                </small>
                                            <% } else { %>
                                                <span class="text-warning">Noch nie</span>
                                            <% } %>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="web-user-actions">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-warning" onclick="resetPassword('<%= webUser.id %>')" title="Passwort zurücksetzen">
                                                <i class="fas fa-key"></i>
                                            </button>
                                            
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" title="Weitere Aktionen">
                                                    <i class="fas fa-cog"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-dark">
                                                    <li><a class="dropdown-item" href="#" onclick="changeRole('<%= webUser.id %>', '<%= webUser.role %>')">
                                                        <i class="fas fa-user-tag"></i> Rolle ändern
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="showWebUserLogs('<%= webUser.id %>')">
                                                        <i class="fas fa-history"></i> Aktivitäts-Log
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="showWebUserSessions('<%= webUser.id %>')">
                                                        <i class="fas fa-desktop"></i> Aktive Sessions
                                                    </a></li>
                                                    <% if (webUser.username !== user.username) { %>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteWebUser('<%= webUser.id %>')">
                                                        <i class="fas fa-trash"></i> Benutzer löschen
                                                    </a></li>
                                                    <% } %>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                
                <% } %>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createWebUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Neuen Web-Benutzer erstellen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createWebUserForm">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">Benutzername</label>
                        <input type="text" class="form-control" id="newUsername" required>
                        <div class="form-text">Mindestens 3 Zeichen, nur Buchstaben und Zahlen</div>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Passwort</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="form-text">Mindestens 6 Zeichen</div>
                    </div>
                    <div class="mb-3">
                        <label for="newRole" class="form-label">Rolle</label>
                        <select class="form-select" id="newRole" required>
                            <option value="mod">Moderator</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <div class="form-text">
                            <strong>Moderator:</strong> Kann Nachrichten und Tickets verwalten<br>
                            <strong>Administrator:</strong> Vollzugriff auf alle Funktionen
                        </div>
                    </div>
                </form>
                <div id="createUserResult" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-squad" onclick="createWebUser()">
                    <i class="fas fa-plus"></i> Erstellen
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user"></i> Benutzer Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Lade Benutzer-Details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="passwordResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key"></i> Passwort zurücksetzen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="passwordResetForm">
                    <div class="mb-3">
                        <label for="resetPassword" class="form-label">Neues Passwort</label>
                        <input type="password" class="form-control" id="resetPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Passwort bestätigen</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
                <div id="passwordResetResult" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-warning" onclick="confirmPasswordReset()">
                    <i class="fas fa-key"></i> Passwort ändern
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="moderationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gavel"></i> Moderation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="moderationContent">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-danger" id="confirmModerationBtn" onclick="confirmModeration()">
                    Bestätigen
                </button>
            </div>
        </div>
    </div>
</div>

<link href="/css/users.css" rel="stylesheet">

<script src="/js/utils.js"></script>
<script src="/js/users.js"></script>