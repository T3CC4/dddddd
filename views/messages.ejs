<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-comments"></i> Nachrichten Log</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportMessages()">
                <i class="fas fa-download"></i> Exportieren
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Aktualisieren
            </button>
        </div>
    </div>
</div>

<!-- Suchformular -->
<div class="discord-search-container">
    <div class="discord-search-form">
        <form method="GET" action="/messages" class="search-form-grid">
            <div class="search-input-wrapper">
                <label class="discord-label">Nachrichten durchsuchen</label>
                <input type="text" class="discord-input" id="search" name="search" 
                       value="<%= search %>" placeholder="Nach Nachricht, Benutzer oder Channel suchen...">
            </div>
            <div class="channel-filter-wrapper">
                <label class="discord-label">Channel Filter</label>
                <select class="discord-select" name="channel" id="channel">
                    <option value="">Alle Channels</option>
                    <% 
                    const channels = [...new Set(messages.map(m => m.channel_name))];
                    channels.forEach(channel => { 
                    %>
                        <option value="<%= channel %>" <%= channel === (typeof channel !== 'undefined' ? channel : '') ? 'selected' : '' %>><%= channel %></option>
                    <% }); %>
                </select>
            </div>
            <div class="search-buttons-wrapper">
                <button type="submit" class="discord-button primary">
                    <i class="fas fa-search"></i> Suchen
                </button>
                <% if (search) { %>
                <a href="/messages" class="discord-button secondary">
                    <i class="fas fa-times"></i> Reset
                </a>
                <% } %>
            </div>
        </form>
    </div>
</div>

<!-- Suchergebnisse Info -->
<% if (search) { %>
<div class="discord-search-results">
    <i class="fas fa-search"></i> 
    Suchergebnisse für: <strong>"<%= search %>"</strong>
    <span class="result-count"><%= messages.length %></span>
</div>
<% } %>

<!-- Discord-Style Nachrichten Container -->
<div class="discord-chat-wrapper">
    <div class="discord-chat-header">
        <div class="channel-name">
            <span class="channel-icon">#</span>
            nachrichten-log
        </div>
        <div class="chat-controls">
            <div class="view-toggle">
                <input type="radio" class="view-radio" name="msgView" id="cozy" autocomplete="off" checked>
                <label class="view-label" for="cozy">
                    <i class="fas fa-align-left"></i> Gemütlich
                </label>
                
                <input type="radio" class="view-radio" name="msgView" id="compact" autocomplete="off">
                <label class="view-label" for="compact">
                    <i class="fas fa-bars"></i> Kompakt
                </label>
            </div>
            <div class="message-count">
                <span id="visibleMessages"><%= messages.length %></span> Nachrichten
            </div>
        </div>
    </div>
    
    <div class="discord-messages-scroller" id="messagesContainer">
        <% if (messages.length === 0) { %>
        <div class="discord-empty-state">
            <div class="empty-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <div class="empty-title">Keine Nachrichten gefunden</div>
            <div class="empty-description">
                Versuche deine Suchbegriffe zu ändern oder einen anderen Channel auszuwählen.
            </div>
        </div>
        <% } else { %>
        
        <div class="discord-messages-list">
            <% 
            let lastAuthor = null;
            let lastDate = null;
            let lastTimestamp = null;
            
            messages.forEach(function(message, index) { 
                const messageDate = new Date(message.timestamp).toDateString();
                const messageTime = new Date(message.timestamp).getTime();
                const showDateDivider = index === 0 || lastDate !== messageDate;
                
                // Zeige Avatar wenn: anderer Autor, anderes Datum, oder mehr als 7 Minuten zwischen Nachrichten
                const showAvatar = lastAuthor !== message.username || 
                                 showDateDivider || 
                                 (lastTimestamp && (messageTime - lastTimestamp) > 7 * 60 * 1000);
                
                lastAuthor = message.username;
                lastDate = messageDate;
                lastTimestamp = messageTime;
            %>
            
            <!-- Date Divider -->
            <% if (showDateDivider) { %>
            <div class="discord-date-divider">
                <div class="divider-line"></div>
                <div class="divider-content">
                    <span class="divider-text">
                        <%= new Date(message.timestamp).toLocaleDateString('de-DE', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) %>
                    </span>
                </div>
                <div class="divider-line"></div>
            </div>
            <% } %>
            
            <div class="discord-message <%= showAvatar ? 'has-avatar' : 'continuation' %> <%= message.deleted ? 'message-deleted' : '' %> <%= message.edited ? 'message-edited' : '' %>" 
                 data-message-id="<%= message.message_id %>" 
                 data-user-id="<%= message.user_id %>" 
                 data-timestamp="<%= message.timestamp %>">
                
                <% if (showAvatar) { %>
                <!-- Avatar Column -->
                <div class="message-avatar-wrapper">
                    <% if (message.user_id === 'SYSTEM') { %>
                        <div class="discord-avatar system-avatar">
                            <i class="fas fa-cog"></i>
                        </div>
                    <% } else { %>
                        <img src="https://cdn.discordapp.com/embed/avatars/<%= parseInt(message.user_id.slice(-1)) % 5 %>.png" 
                             alt="<%= message.username %>" 
                             class="discord-avatar user-avatar">
                    <% } %>
                </div>
                
                <!-- Message Content -->
                <div class="message-content-wrapper">
                    <div class="message-header-line">
                        <span class="message-author <%= message.user_id === 'SYSTEM' ? 'system-author' : '' %>">
                            <%= message.username %>
                        </span>
                        
                        <% if (message.user_id === 'SYSTEM') { %>
                            <span class="bot-tag">BOT</span>
                        <% } %>
                        
                        <span class="message-timestamp-full">
                            <%= new Date(message.timestamp).toLocaleString('de-DE', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            }) %>
                        </span>
                        
                        <% if (message.edited && !message.deleted) { %>
                            <span class="edited-tag">
                                <i class="fas fa-pencil-alt"></i>
                                bearbeitet
                            </span>
                        <% } %>
                        
                        <% if (message.deleted) { %>
                            <span class="deleted-tag">
                                <i class="fas fa-trash"></i>
                                gelöscht
                            </span>
                        <% } %>
                        
                        <span class="channel-badge">
                            <i class="fas fa-hashtag"></i><%= message.channel_name %>
                        </span>
                    </div>
                    
                    <div class="message-content-text">
                        <% if (message.deleted) { %>
                            <span class="deleted-message-content">
                                <i class="fas fa-trash"></i> Diese Nachricht wurde gelöscht
                            </span>
                        <% } else { %>
                            <% if (search && message.content) { %>
                                <%- message.content.replace(new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<mark class="discord-highlight">$1</mark>') %>
                            <% } else { %>
                                <%= message.content || '[Nachricht ohne Inhalt]' %>
                            <% } %>
                        <% } %>
                    </div>
                    
                    <!-- Attachments -->
                    <% if (message.attachments && message.attachments.trim() !== '') { %>
                    <div class="message-attachments">
                        <% 
                        const attachments = message.attachments.split(', ').filter(att => att.trim() !== '');
                        attachments.forEach(function(attachment) { 
                        %>
                        <div class="discord-attachment">
                            <div class="attachment-inner">
                                <div class="attachment-icon">
                                    <i class="fas fa-paperclip"></i>
                                </div>
                                <div class="attachment-details">
                                    <a href="<%= attachment %>" target="_blank" class="attachment-name">
                                        <%= attachment.split('/').pop().substring(0, 50) %><%= attachment.split('/').pop().length > 50 ? '...' : '' %>
                                    </a>
                                    <div class="attachment-size">Anhang</div>
                                </div>
                                <a href="<%= attachment %>" target="_blank" class="attachment-download">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                    <% } %>
                </div>
                <% } else { %>
                <!-- Continuation Message (no avatar) -->
                <div class="message-avatar-wrapper continuation-spacer">
                    <div class="continuation-timestamp">
                        <%= new Date(message.timestamp).toLocaleTimeString('de-DE', { 
                            hour: '2-digit', 
                            minute: '2-digit'
                        }) %>
                    </div>
                </div>
                
                <div class="message-content-wrapper">
                    <div class="message-content-text">
                        <% if (message.deleted) { %>
                            <span class="deleted-message-content">
                                <i class="fas fa-trash"></i> Diese Nachricht wurde gelöscht
                            </span>
                        <% } else { %>
                            <% if (search && message.content) { %>
                                <%- message.content.replace(new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<mark class="discord-highlight">$1</mark>') %>
                            <% } else { %>
                                <%= message.content || '[Nachricht ohne Inhalt]' %>
                            <% } %>
                        <% } %>
                        
                        <% if (message.edited && !message.deleted) { %>
                            <span class="edited-indicator">
                                <i class="fas fa-pencil-alt"></i>
                            </span>
                        <% } %>
                    </div>
                    
                    <!-- Attachments for continuation -->
                    <% if (message.attachments && message.attachments.trim() !== '') { %>
                    <div class="message-attachments">
                        <% 
                        const attachments = message.attachments.split(', ').filter(att => att.trim() !== '');
                        attachments.forEach(function(attachment) { 
                        %>
                        <div class="discord-attachment">
                            <div class="attachment-inner">
                                <div class="attachment-icon">
                                    <i class="fas fa-paperclip"></i>
                                </div>
                                <div class="attachment-details">
                                    <a href="<%= attachment %>" target="_blank" class="attachment-name">
                                        <%= attachment.split('/').pop() %>
                                    </a>
                                    <div class="attachment-size">Anhang</div>
                                </div>
                                <a href="<%= attachment %>" target="_blank" class="attachment-download">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                    <% } %>
                </div>
                <% } %>
                
                <!-- Message Actions (on hover) -->
                <div class="discord-message-actions">
                    <div class="message-actions-inner">
                        <button class="action-button" title="Details anzeigen" onclick="showMessageDetails('<%= message.id %>')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="action-button" title="In Discord anzeigen" onclick="jumpToMessage('<%= message.message_id %>', '<%= message.channel_id %>')">
                            <i class="fab fa-discord"></i>
                        </button>
                        <button class="action-button" title="Nachricht kopieren" onclick="copyMessage('<%= message.content %>')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="action-button" title="Benutzer-ID kopieren" onclick="copyToClipboard('<%= message.user_id %>')">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
            </div>
            <% }); %>
        </div>
        
        <!-- Pagination -->
        <% if (totalPages > 1) { %>
        <div class="discord-pagination">
            <div class="pagination-inner">
                <% if (hasPrev) { %>
                <a class="pagination-button" href="/messages?page=<%= currentPage - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= channel ? '&channel=' + encodeURIComponent(channel) : '' %>">
                    <i class="fas fa-chevron-left"></i> Zurück
                </a>
                <% } %>
                
                <div class="pagination-info">
                    Seite <%= currentPage %> von <%= totalPages %>
                </div>
                
                <% if (hasNext) { %>
                <a class="pagination-button" href="/messages?page=<%= currentPage + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= channel ? '&channel=' + encodeURIComponent(channel) : '' %>">
                    Weiter <i class="fas fa-chevron-right"></i>
                </a>
                <% } %>
            </div>
        </div>
        <% } %>
        
        <% } %>
    </div>
</div>

<!-- Message Details Modal -->
<div class="modal fade" id="messageDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content discord-modal">
            <div class="modal-header discord-modal-header">
                <h5 class="modal-title">Nachrichten Details</h5>
                <button type="button" class="btn-close discord-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body discord-modal-body">
                <div id="messageDetailsContent">
                    <!-- Details werden hier geladen -->
                </div>
            </div>
            <div class="modal-footer discord-modal-footer">
                <button type="button" class="discord-button secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<%
function generateAvatarHash(userId) {
    // Generiere einen konsistenten Hash basierend auf der User ID
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
        const char = userId.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash).toString(16).padStart(8, '0').substring(0, 8);
}
%>

<link href="/css/messages.css" rel="stylesheet">

<script src="/js/messages.js"></script>