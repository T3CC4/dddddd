<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-terminal"></i> Web Activity Logs</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportLogs()">
                <i class="fas fa-download"></i> Exportieren
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Aktualisieren
            </button>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="actionFilter" class="form-label">Aktion Filter</label>
                <select class="form-select" id="actionFilter" onchange="filterLogs()">
                    <option value="">Alle Aktionen</option>
                    <option value="LOGIN">Login</option>
                    <option value="LOGOUT">Logout</option>
                    <option value="VIEW_MESSAGES">Nachrichten anzeigen</option>
                    <option value="VIEW_TICKETS">Tickets anzeigen</option>
                    <option value="CLOSE_TICKET">Ticket schließen</option>
                    <option value="CREATE_WEB_USER">Web-Benutzer erstellen</option>
                    <option value="VIEW_USERS">Benutzer verwalten</option>
                    <option value="VERIFY_USER">Benutzer verifizieren</option>
                    <option value="RESET_PASSWORD">Passwort zurücksetzen</option>
                    <option value="REGENERATE_UNIQUE_PASSWORD">Unique Password regenerieren</option>
                    <option value="DELETE_WEB_USER">Web-Benutzer löschen</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="userFilter" class="form-label">Benutzer Filter</label>
                <select class="form-select" id="userFilter" onchange="filterLogs()">
                    <option value="">Alle Benutzer</option>
                    <% 
                    const uniqueUsers = [...new Set(logs.map(log => log.username).filter(u => u))];
                    uniqueUsers.forEach(user => { 
                    %>
                        <option value="<%= user %>"><%= user %></option>
                    <% }); %>
                </select>
            </div>
            <div class="col-md-4">
                <label for="logSearch" class="form-label">Details durchsuchen</label>
                <input type="text" class="form-control" id="logSearch" placeholder="In Details suchen..." onkeyup="filterLogs()">
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list-ul"></i> Activity Logs
            <span class="badge bg-secondary ms-2" id="logCount"><%= logs.length %></span>
        </h5>
    </div>
    <div class="card-body">
        <% if (logs.length === 0) { %>
        <div class="text-center py-4">
            <i class="fas fa-list fa-3x text-muted mb-3"></i>
            <p class="text-muted">Keine Logs vorhanden.</p>
        </div>
        <% } else { %>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover table-sm" id="logsTable">
                <thead>
                    <tr>
                        <th width="20%">Zeitstempel</th>
                        <th width="15%">Benutzer</th>
                        <th width="20%">Aktion</th>
                        <th width="45%">Details</th>
                    </tr>
                </thead>
                <tbody>
                    <% logs.forEach(function(log) { %>
                    <tr class="log-row" 
                        data-action="<%= log.action %>" 
                        data-user="<%= log.username || 'Unbekannt' %>" 
                        data-search="<%= (log.details || '').toLowerCase() %>">
                        <td>
                            <div class="timestamp-container">
                                <div class="timestamp-date">
                                    <%= new Date(log.timestamp).toLocaleDateString('de-DE') %>
                                </div>
                                <div class="timestamp-time">
                                    <%= new Date(log.timestamp).toLocaleTimeString('de-DE') %>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="user-info">
                                <% if (log.username) { %>
                                    <div class="user-avatar-small">
                                        <i class="fas fa-user-astronaut"></i>
                                    </div>
                                    <div class="user-details">
                                        <div class="username"><%= log.username %></div>
                                        <div class="user-id">ID: <%= log.user_id %></div>
                                    </div>
                                <% } else { %>
                                    <div class="user-avatar-small unknown">
                                        <i class="fas fa-user-times"></i>
                                    </div>
                                    <div class="user-details">
                                        <div class="username text-muted">Unbekannt</div>
                                        <div class="user-id">ID: <%= log.user_id || 'N/A' %></div>
                                    </div>
                                <% } %>
                            </div>
                        </td>
                        <td>
                            <span class="action-badge bg-<%= getActionBadgeColor(log.action) %>">
                                <i class="fas fa-<%= getActionIcon(log.action) %>"></i>
                                <%= log.action %>
                            </span>
                        </td>
                        <td>
                            <div class="log-details">
                                <%= log.details || '-' %>
                            </div>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        
        <% if (totalPages > 1) { %>
        <nav aria-label="Log pagination" class="mt-4">
            <ul class="pagination justify-content-center pagination-sm">
                <% if (hasPrev) { %>
                <li class="page-item">
                    <a class="page-link" href="/logs?page=<%= currentPage - 1 %>">
                        <i class="fas fa-chevron-left"></i> Zurück
                    </a>
                </li>
                <% } %>
                
                <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link" href="/logs?page=<%= i %>"><%= i %></a>
                </li>
                <% } %>
                
                <% if (hasNext) { %>
                <li class="page-item">
                    <a class="page-link" href="/logs?page=<%= currentPage + 1 %>">
                        Weiter <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                <% } %>
            </ul>
        </nav>
        <% } %>
        
        <% } %>
    </div>
</div>

<%
function getActionBadgeColor(action) {
    const colorMap = {
        'LOGIN': 'success',
        'LOGOUT': 'secondary',
        'VIEW_MESSAGES': 'info',
        'VIEW_TICKETS': 'warning',
        'CLOSE_TICKET': 'danger',
        'CREATE_WEB_USER': 'primary',
        'VIEW_USERS': 'info',
        'VERIFY_USER': 'success',
        'RESET_PASSWORD': 'warning',
        'REGENERATE_UNIQUE_PASSWORD': 'warning',
        'DELETE_WEB_USER': 'danger'
    };
    return colorMap[action] || 'secondary';
}

function getActionIcon(action) {
    const iconMap = {
        'LOGIN': 'sign-in-alt',
        'LOGOUT': 'sign-out-alt',
        'VIEW_MESSAGES': 'comments',
        'VIEW_TICKETS': 'ticket-alt',
        'CLOSE_TICKET': 'lock',
        'CREATE_WEB_USER': 'user-plus',
        'VIEW_USERS': 'users',
        'VERIFY_USER': 'check-circle',
        'RESET_PASSWORD': 'key',
        'REGENERATE_UNIQUE_PASSWORD': 'sync-alt',
        'DELETE_WEB_USER': 'trash'
    };
    return iconMap[action] || 'cog';
}
%>

<link href="/css/logs.css" rel="stylesheet">

<script src="/js/logs.js"></script>